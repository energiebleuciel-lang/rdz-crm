<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulaire de demande | EnerSolar</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f3f4f6; min-height: 100vh; padding: 40px 20px; }
    .container { max-width: 600px; margin: 0 auto; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
    h1 { color: #1e3a5f; margin-bottom: 10px; font-size: 1.8rem; }
    .subtitle { color: #64748b; margin-bottom: 30px; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #334155; }
    input, select { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
    input:focus, select:focus { outline: none; border-color: #f59e0b; }
    .checkbox-group { display: flex; align-items: center; gap: 10px; }
    .checkbox-group input { width: auto; }
    .submit-btn { width: 100%; background: #f59e0b; color: white; padding: 16px; font-size: 1.1rem; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: background 0.3s; }
    .submit-btn:hover { background: #d97706; }
    .submit-btn:disabled { background: #94a3b8; cursor: not-allowed; }
    .debug { background: #1e3a5f; color: white; padding: 15px; border-radius: 8px; margin-top: 30px; font-size: 12px; }
    .debug h4 { color: #fbbf24; margin-bottom: 10px; }
    .debug code { color: #4ade80; }
    .success { background: #059669; color: white; padding: 20px; border-radius: 8px; text-align: center; display: none; }
    .error { background: #dc2626; color: white; padding: 15px; border-radius: 8px; margin-top: 15px; display: none; }
  </style>

  <!-- ===== SCRIPT DE TRACKING FORM ===== -->
  <script>
  (function() {
    var CONFIG = {
      API_URL: "https://leadmaster-76.preview.emergentagent.com",
      FORM_CODE: "PV-004",
      LP_CODE: "",
      LIAISON_CODE: "",
      PRODUCT_TYPE: "PV",
      MODE: "redirect"
    };

    var urlParams = new URLSearchParams(window.location.search);
    CONFIG.LP_CODE = urlParams.get("lp") || "DIRECT";
    CONFIG.LIAISON_CODE = urlParams.get("liaison") || "DIRECT_" + CONFIG.FORM_CODE;
    
    var UTM = {
      source: urlParams.get("utm_source") || "",
      medium: urlParams.get("utm_medium") || "",
      campaign: urlParams.get("utm_campaign") || ""
    };

    window.__EnerSolar_CONTEXT__ = CONFIG;

    var formStarted = false;
    window.trackFormStart = function() {
      if (formStarted) return;
      formStarted = true;
      
      console.log("[FORM] Form start tracked");
      document.getElementById('debug-status').textContent = 'Formulaire dÃ©marrÃ© âœ“';
      
      fetch(CONFIG.API_URL + "/api/track/form-start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          form_code: CONFIG.FORM_CODE,
          lp_code: CONFIG.LP_CODE,
          liaison_code: CONFIG.LIAISON_CODE
        })
      })
      .then(r => r.json())
      .then(data => console.log("[FORM] Start tracked:", data))
      .catch(e => console.error("[FORM] Start error:", e));
    };

    window.validatePhone = function(phone) {
      var digits = phone.replace(/\D/g, "");
      if (digits.length === 9 && digits[0] !== "0") digits = "0" + digits;
      if (digits.length !== 10) return { valid: false, error: "Le numÃ©ro doit contenir 10 chiffres" };
      if (!digits.startsWith("0")) return { valid: false, error: "Le numÃ©ro doit commencer par 0" };
      if (digits === "0123456789" || /^0(\d)\1{8}$/.test(digits)) return { valid: false, error: "NumÃ©ro invalide" };
      return { valid: true, phone: digits };
    };

    window.submitLead = function(leadData) {
      document.getElementById('debug-status').textContent = 'Envoi en cours...';
      document.getElementById('submit-btn').disabled = true;
      document.getElementById('error-msg').style.display = 'none';
      
      var phoneCheck = validatePhone(leadData.phone || "");
      if (!phoneCheck.valid) {
        document.getElementById('error-msg').textContent = phoneCheck.error;
        document.getElementById('error-msg').style.display = 'block';
        document.getElementById('submit-btn').disabled = false;
        return Promise.reject(phoneCheck.error);
      }

      var payload = {
        form_id: CONFIG.FORM_CODE,
        phone: phoneCheck.phone,
        nom: leadData.nom || "",
        prenom: leadData.prenom || "",
        email: leadData.email || "",
        code_postal: leadData.code_postal || "",
        departement: (leadData.code_postal || "").substring(0, 2),
        ville: leadData.ville || "",
        type_logement: leadData.type_logement || "",
        statut_occupant: leadData.statut_occupant || "",
        lp_code: CONFIG.LP_CODE,
        liaison_code: CONFIG.LIAISON_CODE,
        source: UTM.source || "",
        utm_source: UTM.source,
        utm_medium: UTM.medium,
        utm_campaign: UTM.campaign,
        rgpd_consent: leadData.rgpd_consent !== false
      };

      console.log("[FORM] Submitting:", payload);

      return fetch(CONFIG.API_URL + "/api/v1/leads", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": "Token crm_0OKlOJkrT2d3Y0ddqw56J8N0xHZf35hWqSxCTvvhE7Y"
        },
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(data => {
        console.log("[FORM] Response:", data);
        if (data.success) {
          document.getElementById('form-container').style.display = 'none';
          document.getElementById('success-msg').style.display = 'block';
          document.getElementById('lead-id').textContent = data.lead_id;
          document.getElementById('debug-status').textContent = 'Lead envoyÃ© âœ“ ID: ' + data.lead_id;
        } else {
          document.getElementById('error-msg').textContent = data.error || data.message || "Une erreur est survenue";
          document.getElementById('error-msg').style.display = 'block';
          document.getElementById('submit-btn').disabled = false;
          document.getElementById('debug-status').textContent = 'Erreur: ' + (data.error || data.message);
        }
        return data;
      })
      .catch(error => {
        console.error("[FORM] Error:", error);
        document.getElementById('error-msg').textContent = "Erreur technique: " + error;
        document.getElementById('error-msg').style.display = 'block';
        document.getElementById('submit-btn').disabled = false;
        document.getElementById('debug-status').textContent = 'Erreur: ' + error;
        throw error;
      });
    };

    // Update debug on load
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById('debug-lp').textContent = CONFIG.LP_CODE;
      document.getElementById('debug-liaison').textContent = CONFIG.LIAISON_CODE;
      document.getElementById('debug-status').textContent = 'PrÃªt';
    });

    console.log("[FORM] Script initialized");
    console.log("[FORM] LP:", CONFIG.LP_CODE, "| Liaison:", CONFIG.LIAISON_CODE);
  })();
  </script>
</head>
<body>
  <div class="container">
    <div id="form-container">
      <h1>ðŸ“‹ Demande de devis solaire</h1>
      <p class="subtitle">Remplissez ce formulaire, nous vous rappelons sous 24h</p>
      
      <div class="form-group">
        <label>TÃ©lÃ©phone *</label>
        <input type="tel" id="phone" onfocus="trackFormStart()" placeholder="06 12 34 56 78" required>
      </div>
      
      <div class="form-group">
        <label>Nom</label>
        <input type="text" id="nom" placeholder="Dupont">
      </div>
      
      <div class="form-group">
        <label>PrÃ©nom</label>
        <input type="text" id="prenom" placeholder="Jean">
      </div>
      
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" placeholder="jean@email.com">
      </div>
      
      <div class="form-group">
        <label>Code Postal</label>
        <input type="text" id="code_postal" placeholder="75001" maxlength="5">
      </div>
      
      <div class="form-group">
        <label>Type de logement</label>
        <select id="type_logement">
          <option value="">SÃ©lectionner...</option>
          <option value="Maison">Maison</option>
          <option value="Appartement">Appartement</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Vous Ãªtes...</label>
        <select id="statut_occupant">
          <option value="">SÃ©lectionner...</option>
          <option value="PropriÃ©taire">PropriÃ©taire</option>
          <option value="Locataire">Locataire</option>
        </select>
      </div>
      
      <div class="form-group checkbox-group">
        <input type="checkbox" id="rgpd" checked>
        <label for="rgpd" style="margin: 0;">J'accepte la politique de confidentialitÃ©</label>
      </div>
      
      <div id="error-msg" class="error"></div>
      
      <button id="submit-btn" class="submit-btn" onclick="submitMyForm()">
        âžœ Recevoir mon devis gratuit
      </button>
    </div>
    
    <div id="success-msg" class="success">
      <h2>âœ… Demande envoyÃ©e !</h2>
      <p style="margin-top: 10px;">Un conseiller vous rappelle sous 24h</p>
      <p style="margin-top: 15px; font-size: 12px; opacity: 0.8;">RÃ©fÃ©rence: <code id="lead-id"></code></p>
    </div>
    
    <div class="debug">
      <h4>ðŸ”§ Debug Panel</h4>
      <p><strong>Form:</strong> <code>PV-004</code></p>
      <p><strong>LP source:</strong> <code id="debug-lp">-</code></p>
      <p><strong>Liaison:</strong> <code id="debug-liaison">-</code></p>
      <p><strong>API:</strong> <code>Emergent Preview</code></p>
      <p><strong>Status:</strong> <span id="debug-status">Chargement...</span></p>
    </div>
  </div>
  
  <script>
  function submitMyForm() {
    submitLead({
      phone: document.getElementById('phone').value,
      nom: document.getElementById('nom').value,
      prenom: document.getElementById('prenom').value,
      email: document.getElementById('email').value,
      code_postal: document.getElementById('code_postal').value,
      type_logement: document.getElementById('type_logement').value,
      statut_occupant: document.getElementById('statut_occupant').value,
      rgpd_consent: document.getElementById('rgpd').checked
    });
  }
  </script>
</body>
</html>
