<analysis>**original_problem_statement:**
The user initially requested a  to  field migration, a new MÃ©dias feature, and several other small fixes. The scope rapidly expanded to a complete overhaul of the lead management system.

**PRODUCT REQUIREMENTS:**
1.  **New Lead Lifecycle:** All incoming leads MUST be saved to the RDZ database, regardless of errors (missing API key, invalid form, invalid phone). These leads should be flagged with appropriate error statuses (, , , ). Leads without a matching order () are marked as  for automatic redistribution later.
2.  **Mandatory Lead Fields:** , , and  are now mandatory. Leads submitted without them are saved but flagged as .
3.  **Full Suite of Admin Features:** Implement frontend and backend for creating, reading, updating, and deleting leads, mass editing/deleting, forcing a lead to a specific CRM, and resetting form statistics.
4.  **Robust Tracking:** Implement reliable tracking for Landing Page (LP) visits and Call-To-Action (CTA) clicks.
5.  **System Hardening:** Lock down critical API keys, schemas, and core logic functions to prevent accidental modifications.
6.  **Deployment:** Prepare the application for deployment to the user's Hostinger environment.

**User's preferred language**: French

**what currently exists?**
The application is a full-stack CRM (React + FastAPI + MongoDB).
- A massive number of features have been implemented, including a full technical audit, system hardening (core/schema locks), and the backend for a new lead lifecycle.
- **Admin UI:** The frontend for all admin features (edit, delete, mass actions, force-send, reset stats) in  and  is complete and was successfully tested by the testing agent.
- **Lead Always Saved Logic:** The  endpoint in  has been critically modified to **always** save a lead, flagging it with an error status (, , , ) instead of rejecting it.
- **Reset Stats Fix:** The logic for resetting form and LP statistics has been fixed to correctly filter out reset items.
- **LP Tracking Fix:** The script generator () has been updated to provide clear instructions and a robust script for tracking LP visits (automatically) and CTA clicks (manually via ).

**Last working item**:
- **Last item agent was working:** The user reported two new critical bugs after the last set of fixes:
    1.  Clicking Forcer envoi (Force Send) on a lead results in a JSON error.
    2.  A lead is being marked as a doublon (duplicate), and the user wants a deep analysis of the logic.
    The agent had just started investigating the  endpoint in .
- **Status:** IN PROGRESS
- **Agent Testing Done:** N
- **Which testing method agent to use?** backend testing agent
- **User Testing Done:** N

**All Pending/In progress Issue list**:
- **Issue 1: Fix  JSON error and analyze duplicate logic (P0)**
- **Issue 2: Implement and Test Lead Aging Scheduler (P1)**

**Issues Detail:**
- **Issue 1:**
  - **Attempted fixes:** The agent has only viewed the  function in . No fixes have been attempted.
  - **Next debug checklist:**
    1.  ** JSON error:**
        *   Examine the return statement of the  function in . The error is likely caused by returning a non-serializable object (like a raw MongoDB document with  or a  object).
        *   The function calls . Trace the response from that function.
        *   Reproduce the error by calling .
    2.  **Duplicate (doublon) analysis:**
        *   Examine the  function in .
        *   Locate the  query that checks for existing leads.
        *   Identify the exact fields (e.g., , ) and the time window (e.g., last 24 hours) used in the query.
        *   Prepare a clear explanation for the user detailing the exact conditions that define a lead as a duplicate.
  - **Why fix this issue?** Force send is a critical admin recovery tool. Understanding the duplicate logic is essential for data integrity and user trust.
  - **Status:** IN PROGRESS
  - **Is recurring issue?** N
  - **Should Test frontend/backend/both after fix?** Backend

- **Issue 2:**
  - **Description:** The lead lifecycle requires leads with status  older than 8 days to be flagged for manual redistribution. A scheduler job was added to  to handle this but it has not been tested.
  - **Next debug checklist:**
    - Verify the scheduler in  correctly runs the  job.
    - Check the logic in  that queries for old leads.
    - Manually create old leads in the database and trigger the job to confirm they are flagged correctly.
  - **Why fix this issue?** This is the final step to complete the user-defined lead lifecycle.
  - **Status:** NOT STARTED
  - **Is recurring issue?** N
  - **Should Test frontend/backend/both after fix?** Backend

**In progress Task List**:
- None.

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
  - P1: Full end-to-end test of the new lead lifecycle ( -> auto-redistribution).
- **Future Tasks:**
  - P1: Implement Sub-accounts feature.
  - P1: Implement detailed Product Type configuration.
  - P2: Add system alerts via email.
  - P3: Add A/B Testing (Campaign Mode).

**Completed work in this session**
- **P0 Admin UI:** Completed and tested the entire frontend for admin features (, ).
- **Critical Bug Fix (Lead always saved):** Modified  to never reject a lead, instead saving it with an appropriate error status (, , , ). Updated the frontend with corresponding badges and filters.
- **Critical Bug Fix (Mandatory Fields):** Made  and  mandatory fields for valid leads and updated the script generator with client-side validation and warnings.
- **Bug Fix (Reset Stats):** Corrected statistics calculation in  and  to correctly ignore reset items ().
- **Bug Fix (LP Tracking):** Revamped the LP script generator in  with clear instructions and a robust  function for tracking clicks.
- **Deployment Prep:** Cleaned up  and added performance optimizations to database queries in  and .

**Earlier issues found/mentioned but not fixed**
- None.

**Known issue recurrence from previous fork**
- None.

**Code Architecture**
- **Backend:**  contains the critical always save lead intake logic.  is under investigation for the current bug.  was updated to generate the corrected tracking scripts.
- **Frontend:**  was significantly updated with new filters and status badges for the new error states.
- **Database:** The  collection now uses new boolean fields (, , , ) and the  enum has been expanded with , , , and .

**Key Technical Concepts**
- **Defensive Lead Intake:** The application now follows a capture everything philosophy. Leads are never rejected at the API endpoint; they are always saved and flagged with an error status for later review by an admin.
- **Stats Reset Flag:** A  flag is used to exclude items from statistical aggregation. All count/sum queries must filter these out using .

**key DB schema**
- **leads:** 
- **tracking:** 

**changes in tech stack**
- None.

**All files of reference**
- **Primary Investigation:**
  -  (for  bug)
  -  (for duplicate logic)
- **Recently Modified:**
  - 
  - 
  - 
  - 
  - 

**Areas that need refactoring**:
-  is large and complex; it could be broken down into smaller components for better maintainability.

**key api endpoints**
-  (**BROKEN** - Under investigation)
-  (Heavily modified for always save logic)
-  (Fixed)

**Critical Info for New Agent**
- **Priority #1:** The user is blocked by two issues: the  JSON error and understanding why leads are marked as duplicates. You must investigate and resolve these immediately.
- **Always Save Philosophy:** Do not re-introduce any logic in  that would cause the  function to  an error before the lead is saved to the database. The new paradigm is to save everything and flag errors.

**documents and test reports created in this job**
- 

**Last 10 User Messages and any pending HUMAN messages**
1.  **User:** Asks for deployment instructions for the console/team.
2.  **User:** Reports reset stats is not working on the live site after deployment. (Agent investigated and fixed).
3.  **User:** Asks for analysis on why LP tracking isn't working.
4.  **User:** Provides the current HTML of a landing page for analysis.
5.  **User:** Complains that the LP script contains FORM-related info and wants scripts to be clear and distinct.
6.  **User:** Confirms GTM/conversion tracking should not be removed.
7.  **User:** Approves the plan to fix the LP script generator.
8.  **User:** Reports an issue with form URL validation via a screenshot. (Agent analyzed it's likely user error).
9.  **User:** **Reports new critical issues via screenshot:  returns a JSON error, and a lead is marked as a doublon. Asks for a deep analysis.** (Current task).
10. **User:** Asks for analysis on the  and  issues. **(PENDING)**

**Project Health Check:**
- **Broken**: The  feature is not working and returns a JSON error, blocking a key admin workflow.

**3rd Party Integrations**
- **ZR7 Digital API:** For sending leads.
- **Maison du Lead (MDL) API:** For sending leads.
- **APScheduler:** Used for background tasks (lead aging).

**Testing status**
- **Testing agent used after significant changes:** YES, for the Admin UI features. Passed 100%.
- **Troubleshoot agent used after agent stuck in loop:** NO
- **Test files created:** None.
- **Known regressions:** The  feature is now broken.

**Credentials to test flow:**
- **UI Login:**  / 

**What agent forgot to execute**
- The scheduled job for flagging leads older than 8 days was implemented in  but never fully tested or verified.</analysis>
